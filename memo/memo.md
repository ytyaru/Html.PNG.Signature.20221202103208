JavaScriptã§PNGãƒ•ã‚¡ã‚¤ãƒ«è§£æï¼ˆã‚·ã‚°ãƒãƒãƒ£ï¼‰

ã€€ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­8ãƒã‚¤ãƒˆå›ºå®šãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚‹ã€‚

<!-- more -->

# ãƒ–ãƒ„

* [DEMO][]
* [ãƒªãƒã‚¸ãƒˆãƒª][]

[DEMO]:https://ytyaru.github.io/Html.PNG.Signature.20221202103208
[ãƒªãƒã‚¸ãƒˆãƒª]:https://github.com/ytyaru/Html.PNG.Signature.20221202103208

```sh
NAME='Html.PNG.Signature.20221202103208'
git clone https://github.com/ytyaru/$NAME
cd $NAME/docs
```

1. ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’èµ·å‹•ã™ã‚‹
1. ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å©ã
1. èµ·å‹•ã—ãŸãƒ–ãƒ©ã‚¦ã‚¶ã§HTTPSã‚’å®Ÿè¡Œã™ã‚‹ï¼ˆChromiumã®å ´åˆã¯ä»¥ä¸‹ï¼‰
	1. `ã“ã®æ¥ç¶šã§ã¯ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãŒä¿è­·ã•ã‚Œã¾ã›ã‚“`ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹
	1. `è©³ç´°è¨­å®š`ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹
	1. `localhost ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ï¼ˆå®‰å…¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰`ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹
1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã¶ï¼ˆæ¬¡ã®ã†ã¡ã„ãšã‚Œã‹ã®æ–¹æ³•ã§ï¼‰
	* ä»»æ„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹
	* ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã™ã‚‹
1. PNGåˆ¤å®šãŒå®Ÿè¡Œã•ã‚Œã‚‹
	* ã‚‚ã—PNGãªã‚‰`ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯PNGå½¢å¼ã§ã™ğŸ˜„`ã¨è¡¨ç¤ºã•ã‚Œã€PNGç”»åƒãŒè¡¨ç¤ºã•ã‚Œã‚‹
	* ã‚‚ã—PNGã§ãªã„ãªã‚‰`ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯PNGå½¢å¼ã§ãªã„ï¼`ã¨è¡¨ç¤ºã•ã‚Œã‚‹

ã€€ãƒ†ã‚¹ãƒˆç”¨PNGç”»åƒã¯ãƒªãƒã‚¸ãƒˆãƒªã®`./docs/asset/image/monar-mark-gold.png`ã«ã‚ã‚‹ã€‚éPNGãƒ•ã‚¡ã‚¤ãƒ«ã¯é©å½“ã«`README.md`ã‚’ä½¿ãˆã°ã„ã„ã€‚

# æ¦‚è¦

* [PNGãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚°ãƒãƒãƒ£][]

[PNGãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚°ãƒãƒãƒ£]:https://www.w3.org/TR/png/#5PNG-file-signature

ã€€PNGãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚Šã€å…ˆé ­8ãƒã‚¤ãƒˆãŒå›ºå®šãƒ‡ãƒ¼ã‚¿`89 50 4E 47 0D 0A 1A 0A`ã«ãªã£ã¦ã„ã‚‹ã€‚

ã€€ã¤ã¾ã‚Šæ¬¡ã®æ‰‹é †ã§ãƒ•ã‚¡ã‚¤ãƒ«ãŒPNGå½¢å¼ã§ã‚ã‚‹ã‹åˆ¤å®šã§ãã‚‹ã€‚

1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
1. ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿é…åˆ—ã¨ã—ã¦è§£é‡ˆã™ã‚‹
1. å…ˆé ­8ãƒã‚¤ãƒˆã‚’èª­ã‚€
1. 3ãŒ`89 50 4E 47 0D 0A 1A 0A`ã§ã‚ã‚‹ãªã‚‰PNGå½¢å¼ã¨åˆ¤å®šã™ã‚‹

ã€€ãµã¤ã†ã¯æ‹¡å¼µå­`.png`ã‹ã©ã†ã‹ã ã‘ã§åˆ¤æ–­ã§ãã‚‹ãŒã€ã“ã®ã‚·ã‚°ãƒãƒãƒ£åˆ¤å®šã®ã»ã†ãŒã‚ˆã‚Šå³å¯†ã«å¯èƒ½ã€‚ç‰¹ã«PNGãƒ•ã‚¡ã‚¤ãƒ«ã‚’è©³ã—ãèª­ã¿å–ã‚Šã€æ›¸ãè¾¼ã¿ã—ãŸã‘ã‚Œã°æœ€åˆã«è¡Œã„ãŸã„ã€‚

# å®Ÿè£…æ¦‚è¦

ã€€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆDnDï¼‰ã‚„ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ã²ã¨ã¤é¸ã¶ã¨ã€PNGã‹ã©ã†ã‹åˆ¤å®šã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã™ã‚‹ã€‚PNGãªã‚‰ç”»åƒã‚’è¡¨ç¤ºã™ã‚‹ã€‚

ã€€[Drag and Drop API][]ã‚„[input type="file" è¦ç´ ][]ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã²ã¨ã¤å–å¾—ã™ã‚‹ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯[File][]ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦è¿”ã•ã‚Œã‚‹ã€‚[File][]ã¯[Blob][]ã‚’ç¶™æ‰¿ã—ãŸå‹ã€‚[arrayBuffer()][]ã§ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã‚‹ã€‚

[Drag and Drop API]:https://developer.mozilla.org/en-US/docs/Web/API/HTML_Drag_and_Drop_API/File_drag_and_drop
[input type="file" è¦ç´ ]:https://developer.mozilla.org/ja/docs/Web/HTML/Element/input/file
[File]:https://developer.mozilla.org/ja/docs/Web/API/File
[Blob]:https://developer.mozilla.org/ja/docs/Web/API/Blob
[arrayBuffer()]:https://developer.mozilla.org/ja/docs/Web/API/Blob/arrayBuffer

## ãƒã‚¤ãƒŠãƒªæ“ä½œAPI

ã€€JavaScriptã«ãŠã‘ã‚‹ãƒã‚¤ãƒŠãƒªæ“ä½œã¯ãŠã‚‚ã«2ç¨®é¡ã‚ã‚‹ã€‚[DataView][]ã¾ãŸã¯å‹ä»˜é…åˆ—ï¼ˆ[TypedArray][]ï¼‰ã‚’ä½¿ã†æ–¹æ³•ã€‚

1. [ArrayBuffer][]ã‚’ç”Ÿæˆï¼å–å¾—ã™ã‚‹
1. [DataView][]ã¾ãŸã¯å‹ä»˜é…åˆ—ï¼ˆ[TypedArray][]ï¼‰ã«å¤‰æ›ã™ã‚‹
1. å„ã‚¯ãƒ©ã‚¹ã®ãƒã‚¤ãƒŠãƒªæ“ä½œAPIã‚’ä½¿ã†

ã€€ä»¥ä¸‹å‚ç…§ã€‚

* [JavaScript ã®å‹ä»˜ãé…åˆ—][]ï¼ˆ[TypedArray][]ï¼‰

### å‹ä»˜é…åˆ—ï¼ˆ[TypedArray][]ï¼‰

#### æ•´æ•°

Byte|Signd|Unsigned|Clamped
----|-----|--------|-------
1|[Int8Array][]|[Uint8Array][]|[Uint8ClampedArray][]|
2|[Int16Array][]|[Uint16Array][]|
4|[Int32Array][]|[UInt32Array][]|
8|[BigInt64Array][]|[BigUint64Array][]|

#### æµ®å‹•å°‘æ•°

Byte|Signd
----|-----
4|[Float32Array][]
8|[Float64Array][]

[JavaScript ã®å‹ä»˜ãé…åˆ—]:https://developer.mozilla.org/ja/docs/Web/JavaScript/Typed_arrays
[TypedArray]:https://developer.mozilla.org/ja/docs/Web/JavaScript/Typed_arrays
[ArrayBuffer]:https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer
[DataView]:https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/DataView
[Int8Array]:https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Int8Array
[Uint8Array]:https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array
[Uint8ClampedArray]:https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Uint8ClampedArray
[Int16Array]:https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Int16Array
[Uint16Array]:https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Uint16Array
[Int32Array]:https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Int32Array
[Uint32Array]:https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Uint32Array
[Float32Array]:https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Float32Array
[Float64Array]:https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Float64Array
[BigInt64Array]:https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/BigInt64Array
[BigUint64Array]:https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/BigUint64Array

# ã‚³ãƒ¼ãƒ‰æŠœç²‹

* index.html
	* main.js
		* drop-box.js
			* png-reader.js

ã€€ES Moduleã§`import`ã™ã‚‹ã€‚

## index.html

ã€€ãƒ•ã‚¡ã‚¤ãƒ©ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’DnDã™ã‚‹é ˜åŸŸã‚’ã¤ãã‚‹ã€‚

ã€€ã¾ãŸã€[input type="file" è¦ç´ ][]ã§ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã™ã‚‹UIã‚’ç”¨æ„ã™ã‚‹ã€‚

```html
<div id="drop-zone" style="border: 1px solid; padding: 30px;">
    <input type="file" name="file" id="file-input">
</div>
```

ã€€ä»Šå›ã¯ES Moduleã‚’ä½¿ã£ãŸã€‚ãã®ãŸã‚[scriptè¦ç´ ][]ã®`type`å±æ€§å€¤ã«`module`ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ã€‚

[scriptè¦ç´ ]:https://developer.mozilla.org/ja/docs/Web/HTML/Element/script

```html
<script type="module" src="js/main.js"></script>
```

## main.js

```javascript
import {DropBox} from "./drop-box.js";
window.addEventListener('DOMContentLoaded', async(event) => {
    const dropBox = new DropBox()
    await dropBox.create()
});
```

ã€€DnDé ˜åŸŸã‚’æç”»ã™ã‚‹å‡¦ç†ã‚’å‘¼ã³å‡ºã™ã€‚

## drop-box.js

ã€€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã™ã‚‹ã€‚

```javascript
fileInput.addEventListener('change', async(e)=>{
    await previewFile(e.target.files[0]);
});
```

ã€€ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã™ã‚‹ã€‚

```javascript
dropZone.addEventListener('drop', async(e)=>{
    var files = e.dataTransfer.files;
    fileInput.files = files;
    await previewFile(files[0]);
}, false);
```

ã€€PNGåˆ¤å®šã®å‘¼å‡ºã¨ç”»åƒè¡¨ç¤ºã€‚

```javascript
async function previewFile(file) {
    preview.innerHTML = '';
    const reader = new PngReader()
    if (await reader.isPng(file, apiSelect.value)) {
        message(`ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯PNGå½¢å¼ã§ã™ğŸ˜„`)
        var fr = new FileReader();
        fr.readAsDataURL(file);
        fr.onload = function() {
            var img = document.createElement('img');
            img.setAttribute('src', fr.result);
            preview.appendChild(img);
        };
    }
    else { message(`ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯PNGå½¢å¼ã§ãªã„ï¼`, true) }
}
```

## png-reader.js

ã€€PNGåˆ¤å®šã€‚[DataView][]ã¨[TypedArray][]ã®2ç¨®é¡ã®æ–¹æ³•ã‚’ç”¨æ„ã—ãŸã€‚`isPng()`ã®ç¬¬äºŒå¼•æ•°`api`ã§æŒ‡å®šã™ã‚‹ã€‚

```javascript
export class PngReader {
    constructor() {}
    async isPng(blob, api='DataView') { // blob/file PNGãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚°ãƒãƒãƒ£ãŒã‚ã‚‹ã‹
        console.log(`isPng()`)
        return ('DataView'===api) ? this.isPngFromDataView(blob) : this.isPngFromTypedArray(blob)
    }
    async isPngFromDataView(blob) { // blob/file PNGãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚°ãƒãƒãƒ£ãŒã‚ã‚‹ã‹
        console.log(`isPngFromDataView`)
        const SIG = [0x89,0x50,0x4E,0x47,0x0D,0x0A,0x1A,0x0A]
        const dv = new DataView(await blob.arrayBuffer())
        if (dv.length < SIG.length) { return false }
        for (let i=0; i<SIG.length; i++) {
            console.log(SIG[i], dv.getUint8(i))
            if (SIG[i] !== dv.getUint8(i)) { return false }
        }
        console.log(`isPng === true`)
        return true
    }
    async isPngFromTypedArray(blob) { // blob/file PNGãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚°ãƒãƒãƒ£ãŒã‚ã‚‹ã‹
        console.log(`isPngFromTypedArray`)
        return this.#equalsArray([0x89,0x50,0x4E,0x47,0x0D,0x0A,0x1A,0x0A], new Uint8Array(await blob.arrayBuffer(), 0, 8))
    }
    #equalsArray(a, b) { // 2ã¤ã®é…åˆ—a,bãŒç­‰ã—ã„ã‹
        console.log(`#equalsArray`)
        console.log(a)
        console.log(b)
        if (a.length !== b.length) { return false }
        for (let i=0; i<a.length; i++) {
            if (a[i] !== b[i]) { return false }
        }
        return true
    }
}
```

ã€€åˆ¤å®šæ–¹æ³•ã¯ç°¡å˜ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­8ãƒã‚¤ãƒˆã‚’å–å¾—ã—ã¦`89 50 4E 47 0D 0A 1A 0A`ã«ãªã£ã¦ã„ã‚Œã°PNGã¨åˆ¤å®šã™ã‚‹ã€‚ã“ã‚Œã¯[PNGãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚°ãƒãƒãƒ£][]ã®ä»•æ§˜ã§ã‚ã‚‹ã€‚

ã€€ã‚ã¨ã¯ãƒã‚¤ãƒˆé…åˆ—ã‚’æ¯”è¼ƒã™ã‚Œã°ã„ã„ã ã‘ãªã®ã ãŒã€‚ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿é…åˆ—ã¯CPUã®ãƒã‚¤ãƒˆã‚ªãƒ¼ãƒ€ãƒ¼ã«ã‚ˆã£ã¦æ–¹å‘ãŒå¤‰ã‚ã‚‹ã€‚ãƒªãƒˆãƒ«ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³ï¼ãƒ“ãƒƒã‚°ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³ãŒã‚ã‚‹ã€‚ã“ã®å·®ã‚’å¸åã—ã¦ãã‚Œã‚‹ã®ãŒ[DataView][]ã€‚ãƒã‚¤ãƒˆã‚ªãƒ¼ãƒ€ãƒ¼ã®å·®ã‚’è€ƒæ…®ã—ãªã‘ã‚Œã°[TypedArray][]ã‚’ä½¿ãˆã°ã„ã„ã€‚ãŸã ã€ã©ã¡ã‚‰ã‚‚ãƒã‚¤ãƒŠãƒªã‚’èª­ã¿æ›¸ãã™ã‚‹APIãŒç•°ãªã‚‹ç‚¹ã¯æ³¨æ„ã€‚ä¸€å¿œã€ä¸¡æ–¹ã®å ´åˆã§ã‚„ã£ã¦ã¿ãŸã€‚

ã€€ã“ã“ã§æ®‹å¿µãªãŠçŸ¥ã‚‰ã›ã€‚ãªã‚“ã¨JavaScriptã¯é…åˆ—ã®æ¯”è¼ƒãŒã§ããªã„ï¼ã€€ãµã¤ã†ä»–ã®è¨€èªãªã‚‰`==`, `===`, `is()`, `equals()`ãªã©ã§ç°¡å˜ã«ã§ãã‚‹ã®ã«â€¦â€¦ã€‚`for`æ–‡ã§1ãƒã‚¤ãƒˆãšã¤ç¢ºèªã™ã‚‹ã—ãªã„ã¨ã„ã†æ®‹å¿µã¶ã‚Šã€‚ãƒ€ã‚µã„ã€‚ãƒ€ã‚µã™ãã‚‹ã€‚[ç­‰ä¾¡æ€§ã®æ¯”è¼ƒã¨åŒä¸€æ€§][]å‚ç…§ã€‚

[ç­‰ä¾¡æ€§ã®æ¯”è¼ƒã¨åŒä¸€æ€§]:https://developer.mozilla.org/ja/docs/Web/JavaScript/Equality_comparisons_and_sameness

```javascript
// é…åˆ—ã®æ¯”è¼ƒãŒã§ããªã„â€¦â€¦
console.log(([0x89,0x50,0x4E,0x47,0x0D,0x0A,0x1A,0x0A] == [0x89,0x50,0x4E,0x47,0x0D,0x0A,0x1A,0x0A]))
console.log(([0x89,0x50,0x4E,0x47,0x0D,0x0A,0x1A,0x0A] === [0x89,0x50,0x4E,0x47,0x0D,0x0A,0x1A,0x0A]))
console.log((new Array([0x89,0x50,0x4E,0x47,0x0D,0x0A,0x1A,0x0A]) == new Array([0x89,0x50,0x4E,0x47,0x0D,0x0A,0x1A,0x0A])))
console.log((new Array([0x89,0x50,0x4E,0x47,0x0D,0x0A,0x1A,0x0A]) === new Array([0x89,0x50,0x4E,0x47,0x0D,0x0A,0x1A,0x0A])))
console.log((new Array([0x89,0x50,0x4E,0x47,0x0D,0x0A,0x1A,0x0A]).is(new Array([0x89,0x50,0x4E,0x47,0x0D,0x0A,0x1A,0x0A]))))
console.log(new Uint8Array([0x89,0x50,0x4E,0x47,0x0D,0x0A,0x1A,0x0A]) == new Uint8Array([0x89,0x50,0x4E,0x47,0x0D,0x0A,0x1A,0x0A]))
console.log(new Uint8Array([0x89,0x50,0x4E,0x47,0x0D,0x0A,0x1A,0x0A]) === new Uint8Array([0x89,0x50,0x4E,0x47,0x0D,0x0A,0x1A,0x0A]))
console.log(new Uint8Array([0x89,0x50,0x4E,0x47,0x0D,0x0A,0x1A,0x0A]).is(new Uint8Array([0x89,0x50,0x4E,0x47,0x0D,0x0A,0x1A,0x0A])))
```

ã€€ã¨ã«ã‹ãJavaScriptã§ãƒã‚¤ãƒŠãƒªæ“ä½œã™ã‚‹è¶…åŸºæœ¬ãŒã§ããŸã€‚ã‚ã¨ã¯PNGã®ãƒãƒ£ãƒ³ã‚¯ã‚’èª­ã‚“ã ã‚Šã€CRCãƒã‚§ãƒƒã‚¯ã‚µãƒ è¨ˆç®—ã‚„ã€zlibã®Deflateåœ§ç¸®ã‚’ã‚„ã£ã¦ã¿ãŸã„ã€‚ã©ã“ã¾ã§ã§ãã‚‹ã‹ãªã€‚

